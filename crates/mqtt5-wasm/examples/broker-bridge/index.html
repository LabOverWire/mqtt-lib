<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Broker Bridge Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        .bridge-diagram {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-family: monospace;
        }
        .brokers-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .broker-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .broker-section.broker-a {
            border-top: 4px solid #007bff;
        }
        .broker-section.broker-b {
            border-top: 4px solid #28a745;
        }
        .broker-section h2 {
            margin-top: 0;
            font-size: 1.3em;
        }
        .broker-a h2 { color: #007bff; }
        .broker-b h2 { color: #28a745; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9em;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .bridge-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9em;
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .client-panel {
            background: #fafafa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border: 1px solid #eee;
        }
        .client-panel h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #555;
        }
        .control-group {
            margin: 10px 0;
        }
        .control-group label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        input {
            width: calc(100% - 22px);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .broker-a button { background: #007bff; }
        .broker-b button { background: #28a745; }
        .broker-a button:hover { background: #0056b3; }
        .broker-b button:hover { background: #218838; }
        .messages {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: white;
            font-size: 0.85em;
        }
        .message {
            padding: 6px;
            margin: 4px 0;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
            border-radius: 2px;
        }
        .broker-a .message { border-left-color: #007bff; }
        .broker-b .message { border-left-color: #28a745; }
        .message.bridged {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .topic {
            font-weight: bold;
            color: #333;
        }
        .payload {
            color: #555;
            margin-top: 2px;
        }
        .bridge-info {
            font-size: 0.85em;
            color: #856404;
        }
        #debug {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #debug strong {
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>WASM Broker Bridge Demo</h1>
        <p>Two in-browser MQTT brokers connected via <strong>MessagePort bridge</strong>, demonstrating bidirectional message forwarding.</p>
        <div class="highlight">
            <strong>How it works:</strong> Broker A and Broker B each run independently in the browser. A bridge connection forwards messages matching <code>sensors/#</code> between them bidirectionally.
        </div>
        <div class="highlight" style="background: #f8d7da; border-left-color: #dc3545;">
            <strong>MQTT v5 <code>no_local</code> flag:</strong> This example uses <code>no_local: true</code> for all subscriptions. This is critical for bidirectional bridges:
            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                <li><strong>Bridge subscriptions:</strong> Without <code>no_local</code>, the bridge receives messages it forwarded, creating an infinite loop.</li>
                <li><strong>Client subscriptions:</strong> Without <code>no_local</code>, clients receive their own published messages back.</li>
            </ul>
        </div>
        <div class="bridge-diagram">
            <pre>
┌─────────────────┐                    ┌─────────────────┐
│    Broker A     │◄────MessagePort────►│    Broker B     │
│   (WASM)       │     Bridge         │   (WASM)       │
│                 │   sensors/#        │                 │
│  ┌───────────┐  │   ◄──────────►     │  ┌───────────┐  │
│  │ Client A  │  │                    │  │ Client B  │  │
│  └───────────┘  │                    │  └───────────┘  │
└─────────────────┘                    └─────────────────┘
            </pre>
        </div>
        <div id="bridge-status" class="bridge-status">Bridge Status: Initializing...</div>
    </div>

    <div class="brokers-container">
        <div class="broker-section broker-a">
            <h2>Broker A (Primary)</h2>
            <div id="broker-a-status" class="status disconnected">Broker: Not Ready</div>

            <div class="client-panel">
                <h3>Client A (connected to Broker A)</h3>
                <div id="client-a-status" class="status disconnected">Client: Disconnected</div>

                <div class="control-group">
                    <label>Subscribe to topic:</label>
                    <input type="text" id="subscribe-topic-a" value="sensors/#">
                    <button id="subscribe-btn-a">Subscribe</button>
                </div>

                <div class="control-group">
                    <label>Publish to topic:</label>
                    <input type="text" id="publish-topic-a" value="sensors/temperature">
                    <input type="text" id="publish-message-a" value='{"value": 23.5, "unit": "C"}'>
                    <button id="publish-btn-a">Publish</button>
                </div>

                <h4>Messages Received:</h4>
                <div id="messages-a" class="messages">
                    <em>No messages yet</em>
                </div>
            </div>
        </div>

        <div class="broker-section broker-b">
            <h2>Broker B (Secondary)</h2>
            <div id="broker-b-status" class="status disconnected">Broker: Not Ready</div>

            <div class="client-panel">
                <h3>Client B (connected to Broker B)</h3>
                <div id="client-b-status" class="status disconnected">Client: Disconnected</div>

                <div class="control-group">
                    <label>Subscribe to topic:</label>
                    <input type="text" id="subscribe-topic-b" value="sensors/#">
                    <button id="subscribe-btn-b">Subscribe</button>
                </div>

                <div class="control-group">
                    <label>Publish to topic:</label>
                    <input type="text" id="publish-topic-b" value="sensors/humidity">
                    <input type="text" id="publish-message-b" value='{"value": 65, "unit": "%"}'>
                    <button id="publish-btn-b">Publish</button>
                </div>

                <h4>Messages Received:</h4>
                <div id="messages-b" class="messages">
                    <em>No messages yet</em>
                </div>
            </div>
        </div>
    </div>

    <div id="debug">
        <strong>Debug Log:</strong>
        <div id="debug-messages"></div>
    </div>

    <script type="module">
        import init, {
            WasmBroker,
            WasmBrokerConfig,
            WasmMqttClient,
            WasmBridgeConfig,
            WasmBridgeDirection,
            WasmTopicMapping,
            WasmSubscribeOptions
        } from './pkg/mqtt5_wasm.js';

        function debugLog(msg) {
            const messagesDiv = document.getElementById('debug-messages');
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            messagesDiv.appendChild(line);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            console.log(msg);
        }

        function updateStatus(elementId, text, connected) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function addMessage(panelId, topic, payload, bridged = false) {
            const messagesEl = document.getElementById(panelId);
            if (messagesEl.querySelector('em')) {
                messagesEl.innerHTML = '';
            }

            const timestamp = new Date().toLocaleTimeString();
            const messageEl = document.createElement('div');
            messageEl.className = `message ${bridged ? 'bridged' : ''}`;
            const topicDiv = document.createElement('div');
            topicDiv.className = 'topic';
            topicDiv.textContent = topic;
            const payloadDiv = document.createElement('div');
            payloadDiv.className = 'payload';
            payloadDiv.textContent = `${payload} (${timestamp})`;
            messageEl.appendChild(topicDiv);
            messageEl.appendChild(payloadDiv);
            if (bridged) {
                const bridgeDiv = document.createElement('div');
                bridgeDiv.className = 'bridge-info';
                bridgeDiv.textContent = 'via bridge';
                messageEl.appendChild(bridgeDiv);
            }
            messagesEl.prepend(messageEl);
        }

        async function setupClient(clientId, broker, statusId, messagesId, subscribeBtnId, subscribeTopicId, publishBtnId, publishTopicId, publishMessageId) {
            const client = new WasmMqttClient(clientId);

            client.on_connect((reasonCode, sessionPresent) => {
                debugLog(`${clientId} connected (reason: ${reasonCode})`);
                updateStatus(statusId, 'Client: Connected', true);
            });

            client.on_disconnect(() => {
                debugLog(`${clientId} disconnected`);
                updateStatus(statusId, 'Client: Disconnected', false);
            });

            client.on_error((error) => {
                debugLog(`${clientId} error: ${error}`);
            });

            document.getElementById(subscribeBtnId).addEventListener('click', async () => {
                const topic = document.getElementById(subscribeTopicId).value;
                if (!topic) return;

                const options = new WasmSubscribeOptions();
                options.noLocal = true;

                await client.subscribe_with_options(topic, (receivedTopic, payload) => {
                    const decoder = new TextDecoder();
                    const message = decoder.decode(payload);
                    addMessage(messagesId, receivedTopic, message);
                    debugLog(`${clientId} received: ${receivedTopic} = ${message}`);
                }, options);
                debugLog(`${clientId} subscribed to: ${topic} (no_local=true)`);
            });

            document.getElementById(publishBtnId).addEventListener('click', async () => {
                const topic = document.getElementById(publishTopicId).value;
                const message = document.getElementById(publishMessageId).value;
                if (!topic || !message) return;

                const encoder = new TextEncoder();
                await client.publish(topic, encoder.encode(message));
                debugLog(`${clientId} published: ${topic} = ${message}`);
            });

            const port = broker.create_client_port();
            await client.connect_message_port(port);

            return client;
        }

        async function main() {
            try {
                debugLog('Initializing WASM...');
                await init();
                debugLog('WASM initialized');

                const config = new WasmBrokerConfig();
                config.max_clients = 100;
                config.wildcard_subscription_available = true;
                config.allow_anonymous = true;

                debugLog('Creating Broker A...');
                const brokerA = WasmBroker.with_config(config);
                updateStatus('broker-a-status', 'Broker: Ready', true);
                debugLog('Broker A ready');

                const configB = new WasmBrokerConfig();
                configB.allow_anonymous = true;
                debugLog('Creating Broker B...');
                const brokerB = WasmBroker.with_config(configB);
                updateStatus('broker-b-status', 'Broker: Ready', true);
                debugLog('Broker B ready');

                debugLog('Setting up bridge from Broker A to Broker B...');
                const bridgeConfig = new WasmBridgeConfig('broker-a-to-b');

                const topicMapping = new WasmTopicMapping('sensors/#', WasmBridgeDirection.Both);
                topicMapping.qos = 1;
                bridgeConfig.add_topic(topicMapping);

                const bridgePort = brokerB.create_client_port();
                await brokerA.add_bridge(bridgeConfig, bridgePort);

                document.getElementById('bridge-status').textContent =
                    'Bridge Status: Active (sensors/# bidirectional)';
                document.getElementById('bridge-status').style.background = '#d4edda';
                document.getElementById('bridge-status').style.color = '#155724';
                document.getElementById('bridge-status').style.borderColor = '#c3e6cb';
                debugLog('Bridge established between Broker A and Broker B');

                debugLog('Connecting Client A to Broker A...');
                await setupClient(
                    'client-a', brokerA, 'client-a-status', 'messages-a',
                    'subscribe-btn-a', 'subscribe-topic-a',
                    'publish-btn-a', 'publish-topic-a', 'publish-message-a'
                );
                debugLog('Client A connected');

                debugLog('Connecting Client B to Broker B...');
                await setupClient(
                    'client-b', brokerB, 'client-b-status', 'messages-b',
                    'subscribe-btn-b', 'subscribe-topic-b',
                    'publish-btn-b', 'publish-topic-b', 'publish-message-b'
                );
                debugLog('Client B connected');

                debugLog('Setup complete! Try subscribing both clients to sensors/# and publishing from either side.');

            } catch (error) {
                debugLog(`ERROR: ${error.message || error}`);
                console.error('Setup error:', error);
                document.getElementById('bridge-status').textContent =
                    `Bridge Status: Error - ${error.message || error}`;
                document.getElementById('bridge-status').style.background = '#f8d7da';
                document.getElementById('bridge-status').style.color = '#721c24';
            }
        }

        main();
    </script>
</body>
</html>
