[config]
default_to_workspace = false

[env]
CARGO_TERM_COLOR = "always"
RUST_BACKTRACE = "1"

[tasks.help]
description = "Show available cargo make commands"
script = '''
#!/bin/bash
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           MQTT v5.0 Library - Available Commands             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“¦ BUILD COMMANDS"
echo "  cargo make build              Build the project with all features"
echo "  cargo make build-release      Build optimized release version"
echo "  cargo make build-cli          Build the mqttv5 CLI tool"
echo "  cargo make check              Run cargo check"
echo "  cargo make clean              Clean build artifacts"
echo ""
echo "âœ… TEST COMMANDS"
echo "  cargo make test               Run all tests (lib, bins, integration)"
echo "  cargo make test-fast          Run only unit and binary tests (fast)"
echo "  cargo make test-cli           Run CLI functionality tests"
echo ""
echo "ðŸ” CODE QUALITY"
echo "  cargo make fmt                Format code (modifies files)"
echo "  cargo make fmt-check          Check formatting without modifying"
echo "  cargo make clippy             Run linter (strict warnings)"
echo ""
echo "ðŸš€ CI/CD WORKFLOWS"
echo "  cargo make ci-verify          Run all CI checks (MUST pass before push)"
echo "  cargo make pre-commit         Quick pre-commit checks (fmt + clippy + tests)"
echo ""
echo "ðŸ“š DOCUMENTATION"
echo "  cargo make doc                Generate documentation"
echo "  cargo doc --open              Generate and open docs in browser"
echo ""
echo "ðŸŒ WASM BUILD (mqtt5-wasm crate)"
echo "  cargo make wasm-check         Check WASM compilation"
echo "  cargo make wasm-clippy        Run clippy for WASM target"
echo "  cargo make wasm-test          Run WASM crate tests (native)"
echo "  cargo make wasm-build         Build WASM package with wasm-pack"
echo "  cargo make wasm-verify        Run all WASM checks"
echo "  cargo make wasm-examples      Build WASM and copy to examples"
echo "  cargo make wasm-publish       Build and publish to npm"
echo ""
echo "ðŸ”§ NO_STD / EMBEDDED (mqtt5-protocol crate)"
echo "  cargo make nostd-check        Check no_std build"
echo "  cargo make nostd-clippy       Run clippy on no_std (pedantic)"
echo "  cargo make nostd-test         Run protocol crate tests"
echo "  cargo make nostd-verify       Run all no_std checks"
echo "  cargo make embedded-cortex-m4 Build for Cortex-M4 (ARM)"
echo "  cargo make embedded-riscv     Build for RISC-V with atomics"
echo "  cargo make embedded-verify    Build for all embedded targets"
echo "  cargo make all-targets        Verify ALL targets (std+wasm+embedded)"
echo ""
echo "ðŸ”’ SECURITY & MAINTENANCE"
echo "  cargo make audit              Check for security vulnerabilities"
echo "  cargo make msrv-check         Check MSRV compatibility (1.83)"
echo ""
echo "ðŸ§ª PERFORMANCE TESTING"
echo "  cargo test --test connection_pool_performance"
echo "  cargo test --test broker_performance_tests"
echo ""
echo "ðŸ“ EXAMPLES"
echo "  cargo run --example simple_broker"
echo "  cargo run --example broker_with_monitoring"
echo "  cargo run --example broker_with_tls"
echo "  cargo run --example broker_with_websocket"
echo "  cargo run --example broker_all_transports"
echo ""
echo "ðŸ’¡ TIP: Run 'cargo make help' anytime to see this menu"
echo ""
'''

[tasks.fmt]
command = "cargo"
args = ["fmt", "--all"]

[tasks.fmt-check]
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.clippy]
command = "cargo"
args = ["clippy", "--all-targets", "--workspace", "--", "-D", "warnings"]

[tasks.test]
command = "cargo"
args = ["test", "--verbose"]

[tasks.test-fast]
command = "cargo"
args = ["test", "--lib", "--bins", "--verbose"]
description = "Run only unit tests and binary tests (excludes integration tests)"

[tasks.test-cli]
dependencies = ["build-cli"]
command = "cargo"
args = ["test", "--test", "cli_functionality", "--", "--nocapture"]
description = "Run CLI functionality tests"

[tasks.build-cli]
command = "cargo"
args = ["build", "--release", "-p", "mqttv5-cli"]
description = "Build the mqttv5 CLI tool"

[tasks.build]
command = "cargo"
args = ["build", "--verbose"]

[tasks.build-release]
command = "cargo"
args = ["build", "--release", "--verbose"]
description = "Build optimized release version"

[tasks.check]
command = "cargo"
args = ["check"]

[tasks.ci-verify]
dependencies = ["fmt-check", "clippy", "wasm-clippy", "build", "test-fast", "test-cli"]
description = "Run all CI checks locally - MUST pass before pushing"

[tasks.pre-commit]
dependencies = ["fmt-check", "clippy", "wasm-clippy", "test-fast"]
description = "Run before committing - checks formatting and runs fast tests"

[tasks.doc]
command = "cargo"
args = ["doc", "--no-deps"]
env = { "RUSTDOCFLAGS" = "-D warnings" }

[tasks.clean]
command = "cargo"
args = ["clean"]

[tasks.audit]
command = "cargo"
args = ["audit"]

[tasks.msrv-check]
toolchain = "1.83"
command = "cargo"
args = ["check"]

[tasks.wasm-check]
command = "cargo"
args = ["check", "--target", "wasm32-unknown-unknown", "--all-features", "-p", "mqtt5-wasm"]
description = "Check WASM compilation without building"

[tasks.wasm-build]
script = '''
#!/bin/bash
set -e
echo "Building WASM package..."
cd crates/mqtt5-wasm

cargo build --target wasm32-unknown-unknown --release --features client,broker,codec

mkdir -p pkg
wasm-bindgen --target web --out-dir pkg ../../target/wasm32-unknown-unknown/release/mqtt5_wasm.wasm

VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
cat > pkg/package.json << EOF
{
  "name": "mqtt5-wasm",
  "type": "module",
  "version": "$VERSION",
  "description": "MQTT v5.0 WebAssembly client and broker for browser environments",
  "license": "MIT OR Apache-2.0",
  "repository": {
    "type": "git",
    "url": "https://github.com/LabOverWire/mqtt-lib"
  },
  "files": [
    "mqtt5_wasm_bg.wasm",
    "mqtt5_wasm.js",
    "mqtt5_wasm.d.ts"
  ],
  "main": "mqtt5_wasm.js",
  "types": "mqtt5_wasm.d.ts",
  "keywords": ["mqtt", "wasm", "webassembly", "iot", "pubsub"]
}
EOF

cp ../../LICENSE-MIT pkg/ 2>/dev/null || true
cp ../../LICENSE-APACHE-2.0 pkg/ 2>/dev/null || true
cp README.md pkg/ 2>/dev/null || true

echo "âœ¨ WASM build complete! Package in crates/mqtt5-wasm/pkg/"
'''
description = "Build WASM package using wasm-bindgen"

[tasks.wasm-examples]
dependencies = ["wasm-build"]
script = '''
#!/bin/bash
echo "Copying WASM package to example directories..."
cd crates/mqtt5-wasm
cp -r pkg examples/websocket/
cp -r pkg examples/local-broker/
echo "âœ¨ WASM examples ready!"
echo ""
echo "Run examples with:"
echo "  cd crates/mqtt5-wasm/examples/websocket && python3 -m http.server 8000"
'''
description = "Build WASM and copy to example directories"

[tasks.wasm-publish]
dependencies = ["wasm-build"]
script = '''
#!/bin/bash
echo "Publishing WASM package to npm..."
cd crates/mqtt5-wasm/pkg
npm pkg fix
npm publish
echo "âœ¨ Published mqtt5-wasm to npm!"
'''
description = "Build and publish WASM package to npm"

[tasks.wasm-clippy]
command = "cargo"
args = ["clippy", "--target", "wasm32-unknown-unknown", "-p", "mqtt5-wasm", "--features", "broker", "--", "-D", "warnings", "-W", "clippy::pedantic"]
description = "Run clippy for WASM target (strict, pedantic)"

[tasks.wasm-test]
command = "cargo"
args = ["test", "-p", "mqtt5-wasm"]
description = "Run WASM crate tests (native)"

[tasks.wasm-verify]
dependencies = ["wasm-check", "wasm-clippy", "wasm-test"]
description = "Run all WASM checks"

[tasks.nostd-check]
command = "cargo"
args = ["check", "-p", "mqtt5-protocol", "--no-default-features"]
description = "Check no_std build (protocol crate)"

[tasks.nostd-clippy]
command = "cargo"
args = ["clippy", "-p", "mqtt5-protocol", "--no-default-features", "--", "-D", "warnings", "-W", "clippy::pedantic"]
description = "Run clippy on no_std build"

[tasks.nostd-test]
command = "cargo"
args = ["test", "-p", "mqtt5-protocol"]
description = "Run protocol crate tests"

[tasks.nostd-verify]
dependencies = ["nostd-check", "nostd-clippy", "nostd-test"]
description = "Run all no_std checks"

[tasks.embedded-cortex-m4]
command = "cargo"
args = ["build", "-p", "mqtt5-protocol", "--target", "thumbv7em-none-eabihf", "--no-default-features"]
description = "Build for Cortex-M4 (ARM embedded)"

[tasks.embedded-riscv]
command = "cargo"
args = ["build", "-p", "mqtt5-protocol", "--target", "riscv32imac-unknown-none-elf", "--no-default-features"]
description = "Build for RISC-V with atomics"

[tasks.embedded-verify]
dependencies = ["embedded-cortex-m4", "embedded-riscv"]
description = "Build for all embedded targets"

[tasks.all-targets]
dependencies = ["ci-verify", "wasm-verify", "nostd-verify", "embedded-verify"]
description = "Verify all targets (std, wasm, no_std, embedded)"